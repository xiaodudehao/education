<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>讨论区-交流评论</title>
    <link rel="stylesheet" href="../node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="../package/bootstrapvalidator-master/dist/css/bootstrapValidator.min.css">
    <!-- 提示框样式 -->
    <link href="../lib/toastr/toastr.min.css" type="text/css" rel="stylesheet">
    <!--  对话框样式  -->
    <link href="../lib/confirm/jquery-confirm.min.css" type="text/css" rel="stylesheet">
    <!--  公共部分样式（除右侧主要内容）  -->
    <link rel="stylesheet" href="../css/stu_discussion/stu_discussion_public.css">
    <link rel="stylesheet" href="../css/stu_discussion/stu_discussion_communication.css">
</head>
<body>
<div class="maincontent">
    <!-- 头部导航栏开始 -->
    <div class="header">
        <div class="banxin">
            <img src="../img/未标题-10.png" class="logo" alt="">
            <ul>
                <li><a href="">首页</a></li>
                <li><a href="">课程</a></li>
                <li><a href="">院校</a></li>
                <li><a href="">立体教材</a></li>
            </ul>
            <div class="search">
                <img class="searchicon" src="../img/未标题-1.png" ></img>
                <input type="text" placeholder="搜索课程或学校">
            </div>
            <div class="login">
                <a href="">
                    <img class="loginicon" src="../img/未标题-2.png"></img>
                </a>
                <!-- 这里的模态框用js实现 -->
                <div class="register" data-toggle="modal" data-target="#myModal">注册</div>
                <!-- 要显示新模态框，修改data-target中的ID就可以了 -->
                <div class="log" data-toggle="modal" data-target="#myModal1">登录</div>
            </div>
        </div>
    </div>
    <!-- 头部导航栏结束 -->
    <div class="mainpartportion">
        <div class="banxin clearfix">
            <div class="leftcatalogue">
                <div class="schoolnam clearfix">
                    <img src="../img/schoolimg.png" alt="" class="fl schoollogo">
                    <div class="fl schnam">上海职业技术学院</div>
                </div>
                <div class="course">
                    <img src="../images/kecheng1.png" alt="" class="courseimg">
                    <!-- <div class="coursenam">建筑材料性能检测</div> -->
                </div>
                <div class="cataloguenam">
                    <a class="left_menu_coursehomepage" href="" >课程首页</a>
                    <a class="left_menu_scoresranking" href="" >学习排行</a>
                    <a class="left_menu_announcement" href="">系统公告</a>
                    <a class="left_menu_standard" href="" >评分标准</a>
                    <a class="left_menu_onlinestudy" href="">在线学习</a>
                    <a class="left_menu_test" href="">作业与测试</a>
                    <a class="left_menu_discussion active" href="">讨论</a>
                </div>
            </div>
            <div class="rightresult">
                <div class="righttitle">
                    讨论区-课堂交流
                </div>
                <div class="communication_reply">
                    <div class="founder_information1">
                        <div class="founder_information">
                            <p>话题创建人： 张三</p>
                            <p>话题创建时间： 2019-06-14</p>
                            <p>话题内容： 水泥的标准制作流程和制作方式</p>
                        </div>
                    </div>
                    <div class="reply_content">
                        <textarea class="reply_text" placeholder="请输入回复内容"></textarea>
                    </div>
                    <div class="reply_btn">
                        <button onclick="reply_discuss()">发表回复</button>
                    </div>
                </div>
                <div class="other_reply_area">
                    <div class="reply_choose_order">
                        <span onclick="time_order()" class="other_choose_text">按时间排序</span>｜<span onclick="comments_num()" class="other_choose_text">按点赞量排序</span>
                    </div>
                    <div class="other_reply">
                        <div class="one_reply">
                            <div class="user_head_img">
                                <img src="../img/teach.png">
                            </div>
                            <div class="other_reply_text">
                                <p>欢迎大家来到讨论区！请学员们认真阅读下面各讨论区板块的内容说明。选择正确的讨论区发贴，这样才能够得到相应的关注。注意：不要有问题，马上发贴，而是先看看在相应讨论区（如共性问题回答区）是不是已经有人发过类似帖子了</p>
                                <div class="other_reply_text2">
                                    <div>
                                        <div class="user_name"><span>风云</span></div> 于2019-06-14发表
                                    </div>
                                    <div>
                                        <span onclick="dianzan()" class="glyphicon glyphicon-heart-empty dianzan"></span>
                                        点赞45
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="one_reply">
                            <img src="../img/teach.png">
                            <div class="other_reply_text">
                                <p>欢迎大家来到讨论区！请学员们认真阅读下面各讨论区板块的内容说明。选择正确的讨论区发贴，这样才能够得到相应的关注。注意：不要有问题，马过类似帖子了</p>
                                <div class="other_reply_text2">
                                    <div>
                                        <span>风云</span> 于2019-06-14发表
                                    </div>
                                    <div>
                                        <span onclick="dianzan()" class="glyphicon glyphicon-heart-empty dianzan"></span>
                                        点赞45
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="one_reply">
                            <img src="../img/teach.png">
                            <div class="other_reply_text">
                                <p>欢迎大家来到讨上发贴，而是先看看在相应讨论区（如共性问题回答区）是不是已经有人发过类似帖子了</p>
                                <div class="other_reply_text2">
                                    <div>
                                        <span>风云</span> 于2019-06-14发表
                                    </div>
                                    <div>
                                        <span onclick="dianzan()" class="glyphicon glyphicon-heart-empty dianzan"></span>
                                        点赞45
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="one_reply">
                            <img src="../img/teach.png">
                            <div class="other_reply_text">
                                <p>欢迎大家来到讨论区！请学员们认真阅读下面各讨论区板块的内容说明。选择正确的讨论区发贴，这样才能够得到相应的关注。注意：不要有先看看在相应讨论区有人发过类似帖子了</p>
                                <div class="other_reply_text2">
                                    <div>
                                        <span>风云</span> 于2019-06-14发表
                                    </div>
                                    <div>
                                        <span onclick="dianzan()" class="glyphicon glyphicon-heart-empty dianzan"></span>
                                        点赞45
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="page_area">
                        <ul id="page"></ul>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- 底部开始 -->
<div class="footercontenter">
    <div class="footer">
        <div class="banxin footerbanxin">
            <div class="footercenter">
                沪公网备案  *****号&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COPYRIGHT © 2008-2012 兰鸿科技
            </div>
        </div>
    </div>
</div>
<!-- 底部结束 -->
<!-- 注册模态框开始 -->
<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="registertitle">
                用户注册
            </div>
            <form id="registerform" name="register"  class="registerform" action="">
                <div class="form-group">

                    <input  name="telephoneemail" placeholder="输入邮箱或手机号" class="telephone" type="text">
                </div>
                <div class="form-group">

                    <input name="username" placeholder="输入用户名" class="username" type="text">
                </div>
                <div class="form-group">

                    <input id="password" name="password" placeholder="输入密码" class="password" type="password">
                </div>
                <!-- <div class="nameexist">该用户名已存在</div> -->
                <div class="registerbutton">立即注册</div>
                <div class="elseregister">
                    <span>其它登录方式</span>
                    <a href=""><img src="../img/qq.png" alt=""></a>
                    <a href=""><img src="../img/weixin.png" alt=""></a>
                    <a href=""><img  src="../img/xinlang.png" alt=""></a>
                    <div class="nameexist">该用户名已存在</div>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- 注册模态框结束 -->
<!-- 登录模态框开始 -->
<div class="modal fade" id="myModal1" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="registertitle">
                用户登录
            </div>
            <form class="registerform loginform" id="loginform" action="">
                <div class="form-group">
                    <input  placeholder="输入用户名" name="username" class="telephone" type="text">
                </div>
                <div class="form-group">
                    <input placeholder="输入密码" name="password" class="username" type="password">
                </div>

                <div class="codefather clearfix">
                    <input  placeholder="输入验证码" name="code" class="code" type="text">
                    <img src="../img/code.png" class="codeimg"></img>
                    <div class="check">换一张</div>
                    <div class="codeerr uperr">
                        ⓧ 用户名或密码错误
                    </div>
                    <div class="codeerr cerr">
                        ⓧ 验证码错误
                    </div>
                </div>

                <div class="loginbutton">立即登录</div>
                <div class="else">

                    <div class="linkregister">注册</div>
                    <div class="forget">忘记密码</div>
                    <span>其它登录方式</span>


                    <a href=""><img src="../img/qq.png" alt=""></a>
                    <a href=""> <img src="../img/weixin.png" alt=""></a>
                    <a href=""><img  src="../img/xinlang.png" alt=""></a>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- 登录模态框结束 -->
<!-- loading Modal start-->
<div class="modal fade" id="loadingModal" data-backdrop="static">
    <div style="width: 200px;height:20px; z-index: 20000; position: absolute; text-align: center; left: 50%; top: 50%;margin-left:-100px;margin-top:-10px">
        <div class="progress progress-striped active" style="margin-bottom: 0;">
            <div class="progress-bar" style="width: 100%;"></div>
        </div>
        <h5 style="color: white; font-weight: bold">努力加载中...</h5>
    </div>
</div>
</body>
<script src="../node_modules/echarts/dist/echarts.common.js" ></script>
<script src="../node_modules/jquery/dist/jquery.min.js" ></script>
<script src="../node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="../package/bootstrapvalidator-master/dist/js/bootstrapValidator.min.js" ></script>
<script src="../js/public.js" ></script>
<!-- 分页器 -->
<script src="../lib/bootstrap-paginator.js"></script>
<!-- 提示框插件 -->
<script src="../lib/toastr/toastr.min.js"></script>
<!-- 对话框样式 -->
<script src="../lib/confirm/jquery-confirm.min.js"></script>
<script type="text/javascript">
    var PageNum = 1
    var stu_url = location.href
    var stu_urlarr = stu_url.split("=")
    var com_id = stu_urlarr[stu_urlarr.length - 1]
    $(function(){
        // 模态框居中
        modalCenter('#myModal')
        modalCenter('#myModal1')
        select_comm_theme(com_id)
        select_discussion_ask(PageNum, com_id)
    })

    //  讨论主题查询--头部
    function select_comm_theme(c_id) {
        $("#loadingModal").modal("show")
        var CouIntrAjax = $.ajax({
            url: HTTP_URLH + "Studymanage/set_forum",
            type: "post",
            timeout: 5000,
            dataType: "json",
            // async:false,    //不进行异步刷新
            data: {
                id: c_id,
            },
            success: function (data) {
                // console.log(data)
                var res = ""
                for (var i in data) {
                    var item = data[i]
                    var a = data[i].data/1
                    var d=new Date(a*1000);
                    var time = formatDate(d)
                    res += '<div class="founder_information">\n' +
                        '                            <p>话题创建人： '+ item.rname +'</p>\n' +
                        '                            <p>话题创建时间： '+ time +'</p>\n' +
                        '                            <p>话题内容： '+ item.discussname +'</p>\n' +
                        '                        </div>'
                }
                $(".founder_information1").html(res)
            },
            error: function (e) {
                console.log(e)
                toastr.error("网络开小猜了，请稍后再试！")
            },
            complete: function (xhr, status) {
                // 隐藏loading
                $("#loadingModal").modal("hide")
            }
        })
    }

    //  查看所有回复信息
    function select_discussion_ask(PageNum,d_id, num) {
        // loading显示
        $("#loadingModal").modal("show")
        var CouIntrAjax = $.ajax({
            url: HTTP_URLH + "Studymanage/set_details",
            type: "post",
            timeout: 5000,
            dataType: "json",
            // async:false,    //不进行异步刷新
            data: {
                did: d_id,
                page: PageNum,
                order: num
            },
            success: function (data) {
                // console.log(data)
                if (0 == data.length) {
                    // 没有数据，显示提示
                    toastr.warning("未查询到可用数据")
                    $("#loadingModal").modal("hide")
                }
                var res = ""
                for (var i=0;i<data.length-1;i++) {
                    var item = data[i]
                    // console.log(item)
                    // console.log(item.id)
                    var k = +i+1
                    // 转换成数字形式“/1”
                    var a = item.data/1
                    var d=new Date(a*1000);
                    var time = formatDate(d)
                    var topic = item.topic
                    var res2 = ""
                    var res3 = ""
                    for (var j in topic) {
                        var item2 = topic[j]
                        res2 += '<img src="'+ imgsrc3 + item2.logo +'">'
                        res3 += '<span>'+ item2.username +'</span>'
                    }
                    $(".user_head_img").html(res2)
                    $(".user_name").html(res3)
                    res += '<div class="one_reply">\n' +
                        '                            <div class="user_head_img">\n' +
                        '                                '+ res2 +'\n' +
                        '                            </div>\n' +
                        '                            <div class="other_reply_text">\n' +
                        '                                <p>'+ item.name +'</p>\n' +
                        '                                <div class="other_reply_text2">\n' +
                        '                                    <div>\n' +
                        '                                        <div class="user_name">'+ res3 +'</div> 于'+ time +'发表\n' +
                        '                                    </div>\n' +
                        '                                    <div>\n' +
                        '                                        <span data-id="'+ item.id +'" class="glyphicon glyphicon-heart-empty dianzan dianzan'+ k +'"></span>\n' +
                        '                                        <span class="'+ item.id +'" >点赞'+ item.praise +'</span>\n' +
                        '                                    </div>\n' +
                        '                                </div>\n' +
                        '                            </div>\n' +
                        '                        </div>'
                    select_dianzan(item.id, k)
                }
                $('.other_reply').html(res)
                //分页
                $("#page").bootstrapPaginator({
                    bootstrapMajorVersion: 3,   //bootstrap版本
                    currentPage: PageNum,  //当前页数
                    totalPages: data[data.length-1].page,   //总页数
                    numberOfPages: 3,    //分页器每页展示页码数
                    shouldShowPage: true,   //所有的按钮都展示
                    itemTexts: function (type, page, current) {
                        // console.log(type)
                        //设置分页控件每部分的显示文字
                        switch (type) {
                            case "first":
                                return "第一页"
                            case "prev":
                                return "上一页"
                            case "next":
                                return "下一页"
                            case "last":
                                return "最后一页"
                            case "page":
                                return page
                            case "jump":
                                return "跳转"
                        }
                    }, onPageClicked: function(event, originalEvent, type, page) {
                        //点击事件
                        //page表示分页控件当前的页码，用这个页码重新走网络请求，会拿到对应的数据
                        pageNum = page
                        // 查询
                        select_discussion_ask(pageNum,com_id, num)
                    }
                })
                $(".dianzan").on("click", function() {
                    // console.log("点")
                    if ($(this).hasClass("isactive")) {
                        $(this).removeClass('isactive');
                    } else {
                        $(this).addClass('isactive');
                    }

                    var thisid = $(this).data("id")
                    console.log(thisid)

                    var DianZanAjax = $.ajax({
                        url: HTTP_URLH + "Studymanage/praise",
                        type: "post",
                        timeout: 5000,
                        dataType: "json",
                        // async:false,    //不进行异步刷新
                        data: {
                            id: 1, // 自身id
                            praise: thisid,
                            val: 2,
                        },
                        success: function (data) {
                            // console.log(data)
                            // select_discussion_ask(PageNum, com_id)
                            // $("."+thisid).html("10")
                            //  刷新点赞数
                            var DianZanAjax = $.ajax({
                                url: HTTP_URLH + "Studymanage/discuss_num",
                                type: "post",
                                timeout: 5000,
                                dataType: "json",
                                // async:false,    //不进行异步刷新
                                data: {
                                    id: thisid, // 自身id
                                },
                                success: function (data) {
                                    console.log(data)
                                    var res = '点赞'+ data +''
                                    $("."+thisid).html(res)
                                },
                                error: function (e) {
                                    console.log(e)
                                    toastr.error("网络开小猜了，请稍后再试！")
                                },
                                complete: function (xhr, status) {
                                    // 隐藏loading
                                    $("#loadingModal").modal("hide")
                                }
                            })

                        },
                        error: function (e) {
                            console.log(e)
                            toastr.error("网络开小猜了，请稍后再试！")
                        },
                        complete: function (xhr, status) {
                            // 隐藏loading
                            $("#loadingModal").modal("hide")
                        }
                    })
                });
            },
            error: function (e) {
                console.log(e)
                toastr.error("网络开小猜了，请稍后再试！")
            },
            complete: function (xhr, status) {
                // 隐藏loading
                $("#loadingModal").modal("hide")
            }
        })
    }

    // 查询点过赞的人
    function select_dianzan(id, k) {
        // console.log(k)
        var DianZanSelAjax = $.ajax({
            url: HTTP_URLH + "Studymanage/estimate",
            type: "post",
            timeout: 5000,
            dataType: "json",
            // async:false,    //不进行异步刷新
            data: {
                id: id,
            },
            success: function (data) {
                // console.log(data)
                // "1" 本人id
                data.includes("1") ? $(".dianzan"+k).addClass('isactive') : ""

            },
            error: function (e) {
                console.log(e)
                toastr.error("网络开小猜了，请稍后再试！")
            },
            complete: function (xhr, status) {
                // 隐藏loading
                $("#loadingModal").modal("hide")
            }
        })
    }

    //  按评论数排序查询
    function comments_num() {
        var num = 1
        select_discussion_ask(PageNum, com_id, num)
    }
    //  按时间排序查询
    function time_order() {
        select_discussion_ask(PageNum, com_id)
    }
    
    // 回复讨论
    function reply_discuss() {
        var text = $(".reply_text").val()
        // console.log(text)
        if (text == ""){
            toastr.warning("请输入评论内容！")
        } else {
            $("#loadingModal").modal("show")
            var CouIntrAjax = $.ajax({
                url: HTTP_URLH + "Studymanage/reply",
                type: "post",
                timeout: 5000,
                dataType: "json",
                // async:false,    //不进行异步刷新
                data: {
                    id: 1,  // 个人id
                    did: com_id,  // 讨论id
                    cid: 1,  // 课程id
                    text: text, // 输入的回复信息
                },
                success: function (data) {
                    // console.log(data)
                    $(".reply_text").val("")
                    select_discussion_ask(PageNum, com_id)
                },
                error: function (e) {
                    console.log(e)
                    toastr.error("网络开小猜了，请稍后再试！")
                },
                complete: function (xhr, status) {
                    // 隐藏loading
                    $("#loadingModal").modal("hide")
                }
            })
        }
    }

    // 时间戳
    function formatDate(now) {
        var year=now.getFullYear();
        var month=now.getMonth()+1;
        var date=now.getDate();
        var hour=now.getHours();
        var minute=now.getMinutes();
        var second=now.getSeconds();
        return year+"-"+month+"-"+date;
    }

    //  点击点赞后加载样式
    $(".dianzan").on("click", function() {
        // console.log("点")
        if ($(this).hasClass("isactive")) {
            $(this).removeClass('isactive');
        } else {
            $(this).addClass('isactive');
        }
    }

    //提示框初始化，toast-top-center表示提示框的位置
    toastr.options = {
        positionClass: 'toast-top-center', // 提示框位置
        closeButton: true  // 是否显示关闭按钮
    }
    /**
     *对话框
     * @param content  提示内容
     * @param func      点击对话框确认按钮做什么，类型为function
     */
    function confirmBySelf(content, func) {
        $.confirm({
            confirmButtonClass: "btn-primary",   //设置ok按钮样式
            closeIcon: true,        //对话框右上角关闭
            confirmButton: "确认", //确认按钮标题
            cancelButton: "取消", //取消按钮标题
            title: "提示",        //标题
            content: content,        //对话内容
            confirm: function () {
                //点击确认后做什么
                func()
            },
            cancel:function () {
                //点击取消后做什么
            }
        })
    }
</script>
</html>